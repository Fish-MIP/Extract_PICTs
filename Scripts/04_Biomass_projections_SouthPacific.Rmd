---
title: "Biomass projections for Pacific Islands Countries and Territories (PICTs)"
author: "Beth Fulton and Denisse Fierro Arcos"
date: "2023-11-29"
output:
  github_document:
    toc: true
    html_preview: false
---

# Generating biomass projections for Pacific Islands Countries and Territories (PICTs)

The workflow described in this notebook was developed by [Dr Beth Fulton](https://orcid.org/0000-0002-5904-7917) (CSIRO) and implemented in `R` by [Denisse Fierro Arcos](https://github.com/lidefi87/). The text describing the methods was largely written by Dr Fulton with minor edits by Denisse.    
    
This notebook implements in `R` the workflow designed to generate demersal fish (and invertebrate) biomass projections for the Pacific Islands Countries and Territories (PICTs) to the year 2100. This workflow uses relationships observed in coral reefs between coral cover and fish biomass, as well as projections of coral cover in the Great Barrier Reef and fish biomass in the Pacific from the [Fisheries and Marine Ecosystem Model Intercomparison Project (FishMIP)](https://fish-mip.github.io/).  
  
## Loading relevant libraries
  
```{r, message = F, warning = F}
library(tidyverse)
library(openxlsx)
library(janitor)
library(mgcv)
```
    
##  models used to generate biomass projections for PICTs
To generate biomass projections for PICTs, we used biomass estimates produced by six different fisheries models:  
1. [APECOSM](https://apecosm.org/): Apex Predators ECOSystem Model, which represents the spatialized dynamics of open ocean pelagic ecosystems in the global ocean.  
2. [BOATS](https://earthsystemdynamics.org/models/boats/): BiOeconomic mArine Trophic Size-spectrum model simulates the global fishery as a coupled ecological-economic system.  
3. [DBPM](https://bitly.ws/36wjv): The Dynamic Benthic Pelagic Model is a dynamic size spectrum model for modelling the coupling "pelagic" size-based predators and "benthic" detritivores that share a unstructured resource pool (detritus).  
4. [EcoTroph](https://doi.org/10.1016/j.ecolmodel.2009.07.031): EcoTroph models the functioning of marine ecosystems as flows of biomass from low to high trophic levels, so as to quantify easily the impacts of fishing at an ecosystem scale.  
5. [Macroecological](https://doi.org/10.1371/journal.pone.0133794): Macroecological is a static equilibrium model, which uses ecological and metabolic scaling theory to predict mean size composition and abundance of animals (including fish).  
6. [ZooMSS](https://doi.org/10.1016/j.ecolmodel.2020.109265): The Zooplankton Model of Size Spectra is a functional size-spectrum model of the marine ecosystem to resolve phytoplankton, nine (9) zooplankton functional groups (heterotrophic flagellates and ciliates, omnivorous and carnivorous copepods, larvaceans, euphausiids, salps, chaetognaths and jellyfish) and three size-based fish groups.  
    
## 1. Biomass projections from REEFMOD data
A relationship between coral cover and fish biomass has been established in the literature. A quick synthesis of existing relationships can be found in the document `Relationships for fish biomass model.docx`.  

### Relationships between coral cover and fish biomass
The most useful relationships came from the [Graham and Nash (2013)](https://doi.org/10.1007/s00338-012-0984-y) data set (explored in `graham_nash_2012_dataset.xlsx`). Using the raw data gives the following relationships:

**Equation 1**: Structural complexity as a function of coral cover. ($r^2$ = 0.4314)  
$struct_{complexity} = 3e^{-7} \times {coral_{cover}}^4 - 5e^{-5} \times {coral_{cover}}^3 + 0.0022 \times {coral_{cover}}^2 + 1.3892$  
  
```{r}
#Base spreadsheet
working_data <- "../Analysis/Excel Sheets/bias_correction_calculations_mean_coral_cover_all_climate_scenarios.xlsx"

#Loading coral cover data
coral <- read.xlsx(working_data, sheet = 1)

#Calculating structural complexity using equation 1 above
coral <- coral |> 
  #rearrange data to facilitate calculations
  pivot_longer(-Year, names_to = "scenario", values_to = "coral_cover") |> 
  #make names small case
  clean_names() |> 
  #calculate structural complexity
  mutate(struct_complex = (3e-7*(coral_cover^4))-((5e-5)*(coral_cover^3))+(0.0022*(coral_cover^2))+1.3892)

#Checking results
head(coral)
```
  
**Equation 2**: Fish biomass ($kg \times ha^{-1}$) as a function of structural complexity ($r^2$ = 0.6102). Note that a logistic is a little poorer fit, so using a quadratic on the argument that once a reef habitat is too complex, it loses places for fish to sit.  
$fish_{biomass} = -2294.6 \times {struct_{complexity}}^2 + 8961.1 \times struct_{complexity} - 6843.6$  
  
In this step, we will also convert fish biomass from $kg \times ha^{-1}$ to $g \times m^{-2}$, so it matches the outputs of FishMIP models.  
  
```{r}
#Calculating fish biomass
coral <- coral |> 
  mutate(fish_biomass_kg_ha = (-2294.6*(struct_complex^2))+(8961.1*struct_complex)-6843.6) |> 
  mutate(fish_biomass = fish_biomass_kg_ha*1000/10000)

#Checking results
head(coral)
```
  
The REEF_MOD project (of Yves-Marie Bozec and Peter Mumby at University of Queensland) has postulated a slightly different set of relationships from the same data (basically a linear relationship).  
  
Fitting a line to the lower, median and upper bounds of this relationship gives the following equations:  
  
**Equation 3**: REEFMOD lower bound equation: $fish_{biomass} = 12.716 \times coral_{cover} + 146.75$  
**Equation 4**: REEFMOD median equation: $fish_{biomass} = 13.56 \times coral_{cover} + 732.15$  
**Equation 5**: REEFMOD upper bound equation: $fish_{biomass} = 14.285 \times coral_{cover} + 1325.7$  
  
```{r}
#Calculating REEFMOD biomass values
coral <- coral |> 
  #lower biomass bound
  mutate(reefmod_lower_biomass = (12.716*coral_cover+146.75)*1000/10000,
         #median biomass
         reefmod_median_biomass = (13.56*coral_cover+732.15)*1000/10000,
         #upper biomass bound
         reefmod_upper_biomass = (14.285*coral_cover+1325.7)*1000/10000) |> 
  #We will drop the biomass in Kg/ha
  select(!fish_biomass_kg_ha)

head(coral)
```
  
Note that the REEFMOD team predicted mean coral coverage from 2024 to 2100 for the Great Barrier Reef (GBR) under five emissions scenarios: `SSP1-1.9`, `SSP1-2.6`, `SSP2-4.5`, `SSP3-7.0`, and `SSP5-8.5`. The above calculations were applied to these five projections.    
  
## 2. Loading biomass estimates from FishMIP models
Global monthly biomass estimates for the historical period (1985-2014) and two emissions scenarios `SSP1-2.6` and `SSP5-8.5` covering the period between 2015 and 2100 were obtained from [six (6) FishMIP models](#fish-mip-models-used-to-generate-biomass-projections-for-picts) forced by both GFDL and IPSL general circulation models. Annual time series per PICT were calculated for each of the FishMIP models.  
  
**Note:** To run the code below, you will need access to the monthly biomass estimates available in the FishMIP server. If you do not have access to the server, we are providing the annual means in the code chunk.  
  
```{r, eval = F}
#Folder containing outputs from FishMIP models
base_folder <- "/rd/gem/private/users/camillan/Extract_tcblog10_Data/Output/sumSize_annual/sizeConsidered10g_10kg/EEZsummaries/gridded_outputs/"
#Listing all relevant files to calculate biomass projections
global_files <- list.files(base_folder, full.names = T)

#Loading PICTs EEZ mask and GBR boundaries (two different grids)
mask_base <- read_csv("../Outputs/mask_1deg.csv")
mask_DBPM <- read_csv("../Outputs/mask_1deg_DBPM.csv")

#Defining function to extract biomass data for all PICTs from FishMIP outputs
mean_yr_bio <- function(file_name){
  if(str_detect(file_name, "dbpm|zoomss_ipsl")){
    mask <- mask_DBPM
  }else{
    mask <- mask_base
  }
  da <- read_csv(file_name, col_select = x:GEONAME) |> 
    #Select data from 1985
    filter(year >= 1985) |> 
    #Rename coordinates
    rename(Lon = x, Lat = y) |> 
    #Extract GBR data - by applying mask
    right_join(mask, by = c("Lon", "Lat")) |> 
    #Calculating mean yearly biomass
    group_by(year, mem, esm, scenario, mask) |> 
    summarise(mean_annual_bio = mean(biomass, na.rm = T))
}

#Apply function to all FishMIP output files
bio_picts <- global_files |> 
  map(\(x) mean_yr_bio(x))

#Combine all list elements into a single data frame
bio_picts <- bio_picts |> 
  list_rbind()

#Saving results for later use
bio_picts |> 
  write_csv("../Outputs/average_yearly_means_picts_1985-2100.csv")

#Checking results
head(bio_picts)
```
  
If you do not have access to the monthly biomass estimates in the FishMIP server, you can load the annual means we calculated in the step above and continue to run all other code chunks in this notebook.  
  
```{r}
bio_picts <- read_csv("../Outputs/average_yearly_means_picts_1985-2100.csv")
```
  
## 3. Estimating biases from GBR data
For scenarios `SSP1-2.6` and `SSP5-8.5`, we will compare the biomass estimates calculated from REEFMOD data (step 1) and the FishMIP model ensemble for the GBR only (step 2 above). We will divide the ensemble mean by the biomass estimates obtained from equation 2 (`fish_biomass` column in `coral` data frame), and by the median, upper, lower bounds obtained from REEFMOD data (equations 3 to 5 stored in the `coral` data frame). These calculations will help us estimate the bias of the FishMIP global model ensemble.  
  
### Extracting GBR data and calculating descriptive statistics
  
```{r}
#Calculating ensemble statistics for GBR only
gbr_bio <- bio_picts |> 
  ungroup() |> 
  #Select GBR means
  filter(mask == 9999) |> 
  #Rename scenarios to match coral data
  mutate(scenario = case_when(scenario == "ssp126" ~ "SSP1-2.6",
                              scenario == "ssp585" ~ "SSP5-8.5",
                              T ~ scenario)) |> 
  group_by(scenario, year) |> 
  summarise(fishmip_lower_bio = min(mean_annual_bio, na.rm = T),
            fishmip_mean_bio = mean(mean_annual_bio, na.rm = T),
            fishmip_upper_bio = max(mean_annual_bio, na.rm = T))

#Checking results
head(gbr_bio)
```
    
### Comparing ensemble means to REEFMOD biomass estimates
This will give us a bias correction for the model ensemble.  
  
```{r}
fishmip_biases <- gbr_bio |> 
  #Adding REEFMOD biomass estimates
  inner_join(coral, by = c("scenario", "year")) |> 
  #Removing coral data that is not needed
  select(!c(coral_cover, struct_complex)) |> 
  #Calculating FishMIP ensemble biases
  mutate(mean_bias_fish_bio_fishmip = fish_biomass/fishmip_mean_bio,
         lower_bias_reefmod_fishmip = reefmod_lower_biomass/fishmip_lower_bio,
         mean_bias_reefmod_fishmip = reefmod_median_biomass/fishmip_mean_bio,
         upper_bias_reefmod_fishmip = reefmod_upper_biomass/fishmip_upper_bio)

#Check results
head(fishmip_biases)
```
  

## 4. Bias corrected biomass projections calculated from FishMIP ensemble
The bias estimates obtained in step 3 above will be used to estimate a corrected mean ensemble biomass values for each PICT under two emission scenarios: `SSP1-2.6` and `SSP5-8.5`.  
  
However, the bias corrections will not be applied per year. Instead, for each scenarios, we will use bias estimates to calculate the following: minimum, mean, median, and maximum.  
  
```{r echo = F}
#Calculating descriptive statistics for bias estimates per scenario
mean_biases <- fishmip_biases |> 
  group_by(scenario) |> 
  #Apply calculations to biases only
  summarise(across(mean_bias_fish_bio_fishmip:upper_bias_reefmod_fishmip, 
                   #Listing statistics to be calculated
                   list(min = min, mean = mean, median = median, max = max), 
                   #Setting column names
                   .names = "{.col}-{.fn}")) |> 
  #Restructuring data frame to ease corrected biomass calculations
  pivot_longer(!scenario, names_to = "bias_type", values_to = "bias_estimate") |> 
  #Separating bias type from statistic calculated
  separate_wider_delim(cols = "bias_type", delim = "-", names = c("bias_type", "stat")) |> 
  pivot_wider(names_from = bias_type, values_from = bias_estimate)

#Checking result
head(mean_biases)
```
  
Next, we exclude biomass values from the GBR (i.e., where `mask` = 9999) from the biomass corrections. This is because we are using GBR data to calculate corrections. As mentioned above, we will calculate the minimum, mean and maximum biomass values using all FishMIP models available for each PICTs under two scenarios.   
  
```{r}
ensemble_bio <- bio_picts |>
  #Removing GBR data
  filter(mask != 9999) |> 
   #Rename scenarios to match coral data
  mutate(scenario = case_when(scenario == "ssp126" ~ "SSP1-2.6",
                              scenario == "ssp585" ~ "SSP5-8.5",
                              T ~ scenario)) |> 
  #Calculations performed by year and EEZ
  group_by(mask, scenario, year) |> 
  #Apply calculations to biases only
  summarise(across(mean_annual_bio, 
                   #Listing statistics to be calculated
                   list(lower = min, mean = mean, max = max), 
                   #Setting column names
                   .names = "{.col}-{.fn}")) |> 
  #Restructuring data frame to ease corrected biomass calculations
  pivot_longer(!c(mask:year), names_to = "ensemble_type", values_to = "ensemble_bio") |> 
  #Separating bias type from statistic calculated
  separate_wider_delim(cols = "ensemble_type", delim = "-", names = c("ensemble_type", "stat")) |> 
  pivot_wider(names_from = ensemble_type, values_from = ensemble_bio)

#Checking results
head(ensemble_bio)
```
  
Note that the mean bias values for scenario `SSP1-2.6` calculated in step 3 will be used to calculated the corrected biomass for the historical period and the two emissions scenarios. Otherwise, if bias values from `SSP5-8.5` are used, the historical biomass values become too divergent.  
  
The corrected biomass will be calculated using this formula: $biomass_{est} = ensemble_{biomass} \times bias_{correction}$.  
  
```{r}
#Extracting mean biases from SSP1-2.6
mean_biases <- mean_biases |> 
  filter(stat == "mean" & scenario == "SSP1-2.6") |> 
  select(ends_with("mip")) |>
  #Matching dimension of FishMIP data to perform bias corrections
  mutate(count = nrow(ensemble_bio)) |> 
  uncount(count)

#Join FishMIP data and mean bias
bias_corr_biomass <- ensemble_bio |> 
  bind_cols(mean_biases) |> 
  #Applying corrections to biomass
  mutate(bio_corr_nash = mean_annual_bio*mean_bias_fish_bio_fishmip,
         bio_corr_reefmod_low = mean_annual_bio*lower_bias_reefmod_fishmip,
         bio_corr_reefmod_mean = mean_annual_bio*mean_bias_reefmod_fishmip,
         bio_corr_reefmod_upper = mean_annual_bio*upper_bias_reefmod_fishmip) |> 
  #Keeping only corrected columns
  select(!mean_annual_bio:upper_bias_reefmod_fishmip)

#Saving outputs
bias_corr_biomass |> 
  write_csv("../Outputs/yearly_corrected_biomass_picts_1985-2100.csv")

#Checking result
head(bias_corr_biomass)
```
  
### Plotting corrected biomass for a single PICTs
We will use biomass values corrected with the Nash derived equation from Kiribati (`mask` = 8441) for the historical period and scenario `SSP1-2.6` as an example.  
  
```{r}
bias_corr_biomass |> 
  ungroup() |> 
  filter(mask == 8441 & scenario != "SSP5-8.5") |> 
  ggplot(aes(x = year, y = bio_corr_nash, color = stat))+
  geom_line()+
  geom_point()+
  theme_bw()+
  labs(y = "Corrected fish biomass (g/m2)")+
  theme(axis.title.x = element_blank(), legend.title = element_blank())
```
  
## 5. Calculating biomass estimates under scenario `SSP2-4.5`
No FishMIP models estimated biomass under scenario `SSP2-4.5`, but we will attempt to estimate fish biomass under this scenario using coral cover estimates (used to derived fish biomass at the beginning of this notebook) scenarios `SSP1-2.6` and `SSP5-8.5`. Below we described the steps we took to achieve this:    
  
1. Plot coral cover under the three scenarios: `SSP1-2.6`, `SSP2-4.5`, and `SSP5-8.5`.  
  
```{r}
#Visualising data
p1 <- coral |> 
  #Selecting three relevant scenarios
  filter(str_detect(scenario, "2.6|4.5|8.5")) |> 
  #Plot coral cover for all scenarios
  ggplot(aes(x = year, y = coral_cover, colour = scenario, linetype = scenario))+
  geom_line()+
  theme_bw()+
  labs(y = "Coral cover (%)")+
  theme(axis.title.x = element_blank(), 
        legend.position = "top", legend.direction = "horizontal")
p1
```
  
2. We can see that scenario `SSP2-4.5` falls somewhere in the middle of the two, so we will calculate a mean of scenarios `SSP1-2.6` and `SSP5-8.5`. We will add this average coral cover to the above plot (black line) to check how well it represents the data.    
  
```{r}
mean_26_85 <- coral |> 
  #Selecting three relevant scenarios
  filter(str_detect(scenario, "2.6|4.5|8.5")) |> 
  #Keeping only columns between year and coral cover
  select(year:coral_cover) |>
  #Reorganise data, so coral cover is now labelled by scenario
  pivot_wider(names_from = scenario, values_from = coral_cover) |> 
  #Clean up column names
  clean_names() |> 
  rowwise() |> 
  mutate(mean_cover = mean(c(ssp1_2_6, ssp5_8_5)))

p1+
  geom_line(inherit.aes = F, data = mean_26_85, aes(x = year, y = mean_cover))
```
  
This averaged coral cover (black line) is closer to coral cover under scenario `SSP2-4.5` (green dashed line), particularly after year 2060, than either of the two scenarios, but it is not a perfect match. 

3. We will need to apply a correction, which we will derive from the proportion between coral cover under scenario `SSP2-4.5` and the mean coral cover under the other two scenarios.   
  
```{r}
mean_26_85 <- mean_26_85 |> 
  #Calculating proportions
  mutate(prop = ssp2_4_5/mean_cover) |> 
  #Removing grouping by row
  ungroup()

#Checking results
head(mean_26_85)
```
  
We can now check that by multiplying the mean coral cover by our correction (`prop` column), we get an exact match of the coral cover under scenario `SSP2-4.5`.  
  
```{r}
mean_26_85 |> 
  #Applying correction
  mutate(corrected = mean_cover*prop) |> 
  #Plotting year along the x axis
  ggplot(aes(x = year))+
  #Plotting corrected mean as a red line
  geom_line(aes(y = corrected), color = "red")+
  #Plotting original coral cover under scenario `SSP2-4.5` as points
  geom_point(aes(y = ssp2_4_5))+
  theme_bw()
```
  
We can see that our corrected mean coral cover (red line) now perfectly matches the coral cover under scenario `SSP2-4.5` (black points). We will not use this proportions as corrections to estimate biomass under scenario `SSP2-4.5` from FishMIP data, instead we will apply a generalised additive model (GAM) to get an approximate of these proportions.  
  
4. Use GAM to calculate corrections per year.  
  
```{r}
#Corrections will be estimated for each year. We will apply a smoother to year 
#to allow GAM to become a polynomial if it fits the data better
gam_mod <- gam(prop ~ s(year, k = 6), data = mean_26_85)

#Now we will apply GAM model to get the corrections
mean_26_85 <- mean_26_85 |> 
  mutate(correction = as.vector(predict(gam_mod, data = mean_26_85, 
                                        type = "response")))

#Plotting data
mean_26_85 |> 
  #Setting year as x axis
  ggplot(aes(x = year))+
  #Plotting original proportions as points
  geom_point(aes(y = prop))+
  #Plotting new corrections as a line
  geom_line(aes(y = correction), color = "red")+
  theme_bw()
```
  
Finally, we can calculate the coral cover under scenario `SSP2-4.5` using the newly calculated correction and the mean coral cover from scenarios `SSP1-2.6` and `SSP5-8.5`.  
  
```{r}
mean_26_85 |> 
  mutate(corrected_mean = mean_cover*correction) |> 
  ggplot(aes(x = year))+
  geom_point(aes(y = ssp2_4_5))+
  geom_line(aes(y = corrected_mean), color = "red")+
  theme_bw()
```
    
5. Finally, we will apply this correction to FishMIP data to calculate fish biomass estimates under scenario `SSP2-4.5`.   
  
```{r}
biomass_ssp245 <- bio_picts |> 
  #select data for future scenarios only
  filter(scenario != "historical") |> 
  pivot_wider(names_from = scenario, values_from = mean_annual_bio) |> 
  rowwise() |> 
  mutate(mean_scenarios = mean(c(ssp126, ssp585))) |> 
  ungroup() 

biomass_ssp245 <- biomass_ssp245 |> 
  mutate(correction = as.vector(predict(gam_mod, biomass_ssp245["year"])),
         ssp245_est = mean_scenarios*correction) |> 
  select(!correction) |> 
  #Calculations performed by year and EEZ
  group_by(mask, year) |>
  summarise(across(ssp126:ssp245_est, 
                   #Listing statistics to be calculated
                   list(min = min, median = median, max = max), 
                   #Setting column names
                   .names = "{.col}-{.fn}")) |> 
  ungroup()

biomass_ssp245 |> 
  filter(mask < 8316) |> 
  select(mask, year, ends_with("median")) |> 
  pivot_longer(ends_with("median"), names_to = "scenario", values_to = "biomass") |> 
  ggplot(aes(x = year, y = biomass, colour = scenario, linetype = scenario))+
  geom_line()+
  facet_wrap(~mask)+
  theme_bw()
```

## Two model approach

```{r}
mod1 <- gam(prop ~ s(year, k = 2), data = mean_26_85 |> filter(year <= 2052))
pred1 <- as.vector(predict(mod1, mean_26_85 |> filter(year <= 2052)))

mod2 <- gam(prop ~ s(year, k = 4), data = mean_26_85 |> filter(year > 2052))
pred2 <- as.vector(predict(mod2, mean_26_85 |> filter(year > 2052)))

mean_26_85 |> 
  mutate(pred2 = c(pred1, pred2)) |> 
  ggplot(aes(x = year))+
  geom_line(aes(y = prop))+
  geom_line(aes(y = pred2), color = "red")


```


```{r}
pred1 <- as.vector(predict(mod1, biomass_ssp245 |> distinct(year) |> filter(year <= 2052)))
preds <- data.frame(year = biomass_ssp245 |> distinct(year), pred = c(pred1, pred2))

biomass_ssp245 |> 
  left_join(preds, by = "year") |> 
  mutate(corr_mean = `mean_scenarios-median`*pred) |> 
  select(mask, year, ends_with("median"), corr_mean) |> 
  pivot_longer(cols = `ssp126-median`:corr_mean, names_to = "scenario", values_to = "biomass") |> 
  group_by(year, mask, scenario) |> 
  summarise(mean = mean(biomass)) |> 
  filter(mask < 8316) |> 
  ggplot(aes(x = year, y = mean, color = scenario))+
  geom_line()+
  facet_wrap(~mask)
```




